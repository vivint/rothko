#!/usr/bin/env bash

set -e

if [ ! -z "$ROTH_USAGE" ]; then
	echo "builds and embeds the ui code into the ui package"
	exit 0
fi

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "${SCRIPTDIR}/.."

log() {
	echo "---" "$@"
}

log "building elm code..."
elm make src/Main.elm --output site/js/Main.js

log "building go code..."
roth gopher

# TODO(jeff): do we bother vulcanizing/minimizing/etc? meh.

log "creating tarball..."
tar czvf ui.tgz -C site .

log "creating go source..."

cat << EOF > ui.go
// Copyright (C) 2018. See AUTHORS.

// Autogenerated by roth deploy; DO NOT EDIT.

// package ui provides a tarball of the compiled ui.
package ui

var Tarball = []byte{
EOF

xxd -g 1 ui.tgz \
	| cut -b 11-57 \
	| sed -e 's/^/	0x/g' \
	| sed -e 's/ /, 0x/g' \
	| sed -e 's/$/,/g' \
	>> ui.go

cat << EOF >> ui.go
}
EOF
