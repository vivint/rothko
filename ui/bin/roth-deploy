#!/usr/bin/env bash

set -e

if [ ! -z "$ROTH_USAGE" ]; then
	echo "builds and embeds the ui code into the ui package"
	exit 0
fi

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "${SCRIPTDIR}/.."

../scripts/check-vgo.sh || exit $?

ELM="$(npm prefix)/node_modules/.bin/elm"

if [ ! -f "$ELM" ]; then
	echo
	echo "elm not found. try running:"
	echo "	roth onboard"
	echo "and then this command again."
	echo
	exit 1
fi

log() {
	echo "---" "$@"
}

log "building elm code..."
elm package install
elm make src/Main.elm --output site/js/Main.js

log "building go code..."
roth gopher

log "creating tarball..."
tar czvf ui.tgz -C site .

log "creating go source..."

cat << EOF > ui.go
// Copyright (C) 2018. See AUTHORS.

// Autogenerated by roth deploy; DO NOT EDIT.

package ui

// Tarball contains a gzipped tar archive to be served for the ui.
var Tarball = tarball

var tarball = []byte{
EOF

xxd -ps ui.tgz \
	| sed -e 's/\(..\)/0x\1, /g' \
	| sed -e 's/^\(.*\) $/	\1/g' \
	>> ui.go

cat << EOF >> ui.go
}
EOF

log "ui package updated."
